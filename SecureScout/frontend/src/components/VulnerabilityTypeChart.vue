<template>
  <div class="w-full h-full">
    <Pie
      v-if="loaded && !isEmpty"
      :data="chartData"
      :options="chartOptions"
    />
    <div v-else-if="isEmpty" class="flex items-center justify-center h-full">
      <p class="text-gray-500">暂无漏洞数据</p>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { Pie } from 'vue-chartjs'
import { Chart as ChartJS, ArcElement, Tooltip, Legend, Title } from 'chart.js'

// 注册ChartJS组件
ChartJS.register(ArcElement, Tooltip, Legend, Title)

const props = defineProps({
  vulnerabilityData: {
    type: Object,
    required: true,
    default: () => ({})
  }
})

const loaded = ref(false)
const isEmpty = computed(() => {
  const counts = Object.values(props.vulnerabilityData)
  return counts.length === 0 || counts.every(count => count === 0)
})

// 漏洞类型中文名称映射
const vulnerabilityTypeNames = {
  'sql_injection': 'SQL注入',
  'xss': '跨站脚本(XSS)',
  'csrf': '跨站请求伪造(CSRF)',
  'file_upload': '文件上传漏洞',
  'error': '错误',
  'other': '其他'
}

// 漏洞类型对应的颜色
const vulnerabilityColors = {
  'sql_injection': '#ff4d4f',
  'xss': '#faad14',
  'csrf': '#1890ff',
  'file_upload': '#722ed1',
  'error': '#bfbfbf',
  'other': '#52c41a'
}

// 图表数据
const chartData = computed(() => {
  if (isEmpty.value) return { labels: [], datasets: [{ data: [] }] }
  
  const labels = []
  const data = []
  const backgroundColor = []
  
  Object.entries(props.vulnerabilityData).forEach(([type, count]) => {
    // 获取显示名称，如果没有映射则使用原名
    const displayName = vulnerabilityTypeNames[type] || (type.charAt(0).toUpperCase() + type.slice(1)).replace(/_/g, ' ')
    labels.push(displayName)
    data.push(count)
    
    // 获取颜色，如果没有颜色则使用默认颜色
    const color = vulnerabilityColors[type] || '#1890ff'
    backgroundColor.push(color)
  })
  
  return {
    labels,
    datasets: [
      {
        data,
        backgroundColor,
        borderWidth: 1,
        borderColor: '#ffffff'
      }
    ]
  }
})

// 图表选项
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      position: 'right',
      labels: {
        boxWidth: 15,
        font: {
          size: 12
        }
      }
    },
    title: {
      display: false
    },
    tooltip: {
      callbacks: {
        label: function(context) {
          const label = context.label || ''
          const value = context.parsed || 0
          const total = context.dataset.data.reduce((a, b) => a + b, 0)
          const percentage = Math.round((value / total) * 100)
          return `${label}: ${value} (${percentage}%)`
        }
      }
    }
  }
}

// 在组件挂载后设置加载完成状态
onMounted(() => {
  loaded.value = true
})

// 当漏洞数据变化时更新图表
watch(() => props.vulnerabilityData, () => {
  loaded.value = true
}, { deep: true })
</script> 