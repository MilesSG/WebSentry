<template>
  <div class="vulnerability-visualizer">
    <!-- 漏洞概览卡片 -->
    <div class="overview-card bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-lg font-semibold mb-4">{{ title }}</h3>
      
      <div v-if="!vulnerabilities || vulnerabilities.length === 0" class="text-center py-4">
        <el-empty description="未发现漏洞" />
      </div>
      
      <div v-else>
        <!-- 漏洞数量指标 -->
        <div class="flex items-center justify-between mb-4">
          <div class="text-xl font-bold">
            发现 <span class="text-danger">{{ vulnerabilities.length }}</span> 个漏洞
          </div>
          
          <div class="flex gap-2">
            <el-tag v-if="getSeverityCount('高') > 0" type="danger">
              高危: {{ getSeverityCount('高') }}
            </el-tag>
            <el-tag v-if="getSeverityCount('中') > 0" type="warning">
              中危: {{ getSeverityCount('中') }}
            </el-tag>
            <el-tag v-if="getSeverityCount('低') > 0" type="info">
              低危: {{ getSeverityCount('低') }}
            </el-tag>
          </div>
        </div>
        
        <!-- 漏洞分布图 -->
        <div ref="chartRef" class="h-60 mb-4"></div>
        
        <!-- 安全评分 -->
        <div class="flex items-center justify-between">
          <div class="flex flex-col items-center">
            <div class="mb-1">安全评分</div>
            <div class="relative">
              <el-progress 
                type="dashboard" 
                :percentage="securityScore" 
                :color="getScoreColor(securityScore)"
                :stroke-width="8"
              />
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-2xl font-bold">{{ securityScore }}</span>
              </div>
            </div>
          </div>
          
          <div class="recommendation p-4 bg-gray-50 rounded-lg max-w-md">
            <div class="font-medium mb-2">安全建议</div>
            <div class="text-sm text-gray-700">
              {{ securityRecommendation }}
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 漏洞详情列表 -->
    <div v-if="vulnerabilities && vulnerabilities.length > 0" class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">漏洞详情</h3>
        <el-radio-group v-model="filter" size="small">
          <el-radio-button label="all">全部</el-radio-button>
          <el-radio-button label="sql_injection" v-if="hasVulnType('sql_injection')">SQL注入</el-radio-button>
          <el-radio-button label="xss" v-if="hasVulnType('xss')">XSS</el-radio-button>
          <el-radio-button label="csrf" v-if="hasVulnType('csrf')">CSRF</el-radio-button>
          <el-radio-button label="file_upload" v-if="hasVulnType('file_upload')">文件上传</el-radio-button>
          <el-radio-button label="other" v-if="hasOtherVulnTypes">其他</el-radio-button>
        </el-radio-group>
      </div>
      
      <!-- 漏洞列表 -->
      <el-table :data="filteredVulnerabilities" style="width: 100%">
        <el-table-column label="漏洞类型" min-width="120">
          <template #default="{ row }">
            <div class="flex items-center">
              <el-tag :type="getTypeColor(row.type)" class="mr-2">
                {{ getVulnTypeName(row.type) }}
              </el-tag>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="风险等级" width="100">
          <template #default="{ row }">
            <el-tag 
              :type="getSeverityType(row.severity)" 
              effect="dark"
              size="small"
            >
              {{ row.severity }}
            </el-tag>
          </template>
        </el-table-column>
        
        <el-table-column label="位置" min-width="200">
          <template #default="{ row }">
            <el-tooltip
              :content="row.url || row.test_url || '无位置信息'"
              placement="top"
              :show-after="500"
            >
              <span class="truncate block">{{ row.url || row.test_url || '无位置信息' }}</span>
            </el-tooltip>
          </template>
        </el-table-column>
        
        <el-table-column label="描述" min-width="250">
          <template #default="{ row }">
            <div>{{ row.description }}</div>
          </template>
        </el-table-column>
        
        <el-table-column label="操作" width="100" fixed="right">
          <template #default="{ row }">
            <el-button
              text
              type="primary"
              @click="showVulnDetails(row)"
            >
              详情
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
    
    <!-- 漏洞详情对话框 -->
    <el-dialog
      v-model="dialogVisible"
      title="漏洞详情"
      width="60%"
      destroy-on-close
    >
      <template v-if="selectedVuln">
        <div class="vuln-detail">
          <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-medium">{{ getVulnTypeName(selectedVuln.type) }}</h3>
              <el-tag 
                :type="getSeverityType(selectedVuln.severity)" 
                effect="dark"
              >
                {{ selectedVuln.severity }}
              </el-tag>
            </div>
            <p>{{ selectedVuln.description }}</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div v-if="selectedVuln.url">
              <div class="text-sm text-gray-500 mb-1">URL:</div>
              <div class="break-all">{{ selectedVuln.url }}</div>
            </div>
            
            <div v-if="selectedVuln.test_url">
              <div class="text-sm text-gray-500 mb-1">测试URL:</div>
              <div class="break-all">{{ selectedVuln.test_url }}</div>
            </div>
          </div>
          
          <div v-if="selectedVuln.details" class="mb-4">
            <div class="text-sm text-gray-500 mb-1">详细信息:</div>
            <div class="bg-gray-50 p-3 rounded font-mono text-sm overflow-auto max-h-40">
              {{ selectedVuln.details }}
            </div>
          </div>
          
          <div v-if="selectedVuln.evidence" class="mb-4">
            <div class="text-sm text-gray-500 mb-1">证据:</div>
            <div class="bg-gray-50 p-3 rounded font-mono text-sm overflow-auto max-h-40">
              {{ selectedVuln.evidence }}
            </div>
          </div>
          
          <el-divider>修复建议</el-divider>
          
          <div v-if="selectedVuln.type === 'sql_injection'">
            <SQLInjectionGuidance />
          </div>
          <div v-else-if="selectedVuln.type === 'xss'">
            <XSSGuidance />
          </div>
          <div v-else>
            <div class="text-sm">
              {{ getRemediationAdvice(selectedVuln.type) }}
            </div>
          </div>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { ElMessage } from 'element-plus'
import * as echarts from 'echarts/core'
import { PieChart } from 'echarts/charts'
import { TooltipComponent, LegendComponent, TitleComponent } from 'echarts/components'
import { CanvasRenderer } from 'echarts/renderers'
import SQLInjectionGuidance from './guidance/SQLInjectionGuidance.vue'
import XSSGuidance from './guidance/XSSGuidance.vue'

// 注册必要的ECharts组件
echarts.use([PieChart, TooltipComponent, LegendComponent, TitleComponent, CanvasRenderer])

const props = defineProps({
  title: {
    type: String,
    default: '漏洞分析'
  },
  vulnerabilities: {
    type: Array,
    default: () => []
  }
})

const chartRef = ref(null)
const chart = ref(null)
const filter = ref('all')
const dialogVisible = ref(false)
const selectedVuln = ref(null)

// 漏洞类型名称映射
const vulnTypeNames = {
  'sql_injection': 'SQL注入',
  'xss': '跨站脚本(XSS)',
  'csrf': '跨站请求伪造(CSRF)',
  'file_upload': '文件上传漏洞',
  'error': '错误'
}

// 漏洞修复建议
const remediationAdvice = {
  'sql_injection': '1. 使用参数化查询或预编译语句\n2. 对所有用户输入进行严格验证\n3. 使用ORM框架\n4. 限制数据库账户权限\n5. 在应用层实施输入/输出过滤',
  'xss': '1. 对所有用户输入进行HTML转义\n2. 实施内容安全策略(CSP)\n3. 使用现代框架的安全绑定\n4. 设置适当的X-XSS-Protection头\n5. 避免直接将用户输入插入到JavaScript中',
  'csrf': '1. 在所有表单中使用CSRF令牌\n2. 验证请求头中的Referer\n3. 对敏感操作使用验证码\n4. 使用SameSite Cookie属性\n5. 实施双重提交Cookie模式',
  'file_upload': '1. 验证文件类型、大小和内容\n2. 使用安全的文件名和存储路径\n3. 不要运行上传的文件\n4. 将文件存储在Web根目录之外\n5. 使用CDN或专用服务器处理文件',
  'error': '检查系统日志以获取更多信息'
}

// 计算属性
const securityScore = computed(() => {
  if (!props.vulnerabilities || props.vulnerabilities.length === 0) return 100
  
  // 按严重程度赋予不同的权重
  const weights = {
    '高': 25,
    '中': 15,
    '低': 5
  }
  
  let weightedSum = 0
  props.vulnerabilities.forEach(vuln => {
    weightedSum += weights[vuln.severity] || weights['中']
  })
  
  // 计算得分并确保在0-100之间
  const score = Math.max(0, 100 - weightedSum)
  return Math.round(score)
})

const securityRecommendation = computed(() => {
  const score = securityScore.value
  
  if (score >= 90) {
    return '网站安全状况良好，建议定期进行安全扫描以保持良好的安全状态。'
  } else if (score >= 70) {
    return '网站存在一些潜在安全隐患，建议及时修复发现的漏洞并加强安全防护措施。'
  } else if (score >= 40) {
    return '网站存在较多安全风险，建议立即修复高危漏洞并对网站进行全面的安全评估和加固。'
  } else {
    return '网站存在严重安全风险，建议立即下线处理并进行全面的安全重构。'
  }
})

const filteredVulnerabilities = computed(() => {
  if (filter.value === 'all') {
    return props.vulnerabilities
  } else if (filter.value === 'other') {
    // 筛选不属于主要分类的其他漏洞
    const mainTypes = ['sql_injection', 'xss', 'csrf', 'file_upload']
    return props.vulnerabilities.filter(vuln => !mainTypes.includes(vuln.type))
  } else {
    // 按类型筛选
    return props.vulnerabilities.filter(vuln => vuln.type === filter.value)
  }
})

const hasOtherVulnTypes = computed(() => {
  const mainTypes = ['sql_injection', 'xss', 'csrf', 'file_upload']
  return props.vulnerabilities.some(vuln => !mainTypes.includes(vuln.type))
})

// 方法
function hasVulnType(type) {
  return props.vulnerabilities.some(vuln => vuln.type === type)
}

function getVulnTypeName(type) {
  return vulnTypeNames[type] || type
}

function getRemediationAdvice(type) {
  return remediationAdvice[type] || '请参考相关安全指南进行修复'
}

function getSeverityCount(severity) {
  return props.vulnerabilities.filter(vuln => vuln.severity === severity).length
}

function getSeverityType(severity) {
  switch (severity) {
    case '高': return 'danger'
    case '中': return 'warning'
    case '低': return 'info'
    default: return 'warning'
  }
}

function getTypeColor(type) {
  switch (type) {
    case 'sql_injection': return 'danger'
    case 'xss': return 'warning'
    case 'csrf': return 'info'
    case 'file_upload': return 'warning'
    default: return 'info'
  }
}

function getScoreColor(score) {
  if (score >= 90) return '#67C23A'
  if (score >= 70) return '#E6A23C'
  if (score >= 40) return '#F56C6C'
  return '#F56C6C'
}

function showVulnDetails(vuln) {
  selectedVuln.value = vuln
  dialogVisible.value = true
}

function initChart() {
  if (!chartRef.value) return
  
  // 销毁旧图表
  if (chart.value) {
    chart.value.dispose()
  }
  
  // 如果没有漏洞，不初始化图表
  if (!props.vulnerabilities || props.vulnerabilities.length === 0) return
  
  // 按类型统计漏洞
  const vulnTypeCount = {}
  props.vulnerabilities.forEach(vuln => {
    const type = getVulnTypeName(vuln.type)
    vulnTypeCount[type] = (vulnTypeCount[type] || 0) + 1
  })
  
  // 准备数据
  const data = Object.entries(vulnTypeCount).map(([name, value]) => ({ name, value }))
  
  // 初始化图表
  chart.value = echarts.init(chartRef.value)
  
  // 配置图表
  const option = {
    tooltip: {
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
      top: '5%',
      left: 'center',
      data: data.map(item => item.name)
    },
    series: [
      {
        name: '漏洞类型',
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: {
          show: false,
          position: 'center'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: '18',
            fontWeight: 'bold'
          }
        },
        labelLine: {
          show: false
        },
        data: data
      }
    ]
  }
  
  // 渲染图表
  chart.value.setOption(option)
}

// 监听漏洞数据变化，重新初始化图表
watch(() => props.vulnerabilities, () => {
  initChart()
}, { deep: true })

// 组件挂载后初始化图表
onMounted(() => {
  initChart()
  
  // 响应窗口大小变化
  window.addEventListener('resize', () => {
    if (chart.value) {
      chart.value.resize()
    }
  })
})
</script>

<style scoped>
.vulnerability-visualizer {
  width: 100%;
}
</style> 